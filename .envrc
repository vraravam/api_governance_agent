#!/bin/bash
# ==============================================
# direnv configuration for API Governance Agent
# ==============================================
# Automatically sets up environment when you cd into this directory

echo "ðŸ”§ Setting up API Governance Agent environment..."

# ============================================
# 1. PYTHON VIRTUAL ENVIRONMENT
# ============================================
if [ ! -d ".venv" ]; then
  echo "ðŸ“¦ Creating Python virtual environment..."
  python3 -m venv .venv
fi

# Activate virtual environment
source .venv/bin/activate

# Install Python dependencies if needed
if [ -f "requirements.txt" ]; then
  if [ ! -f ".venv/.deps_installed" ]; then
    echo "ðŸ“¥ Installing Python dependencies..."
    pip install -q -r requirements.txt
    touch .venv/.deps_installed
    echo "âœ… Python dependencies installed"
  fi
fi

# ============================================
# 2. PYTHONPATH SETUP
# ============================================
# Add the src directory to PYTHONPATH
export PYTHONPATH="${PWD}/src:${PYTHONPATH}"

# ============================================
# 3. NODE.JS DEPENDENCIES (SPECTRAL)
# ============================================
if [ -d "rules" ]; then
  if [ ! -d "rules/node_modules" ]; then
    echo "ðŸ“¥ Installing Spectral dependencies..."
    (cd rules && npm install --silent 2>/dev/null)
    echo "âœ… Spectral dependencies installed"
  fi
fi

# ============================================
# 4. JAVA DEPENDENCIES (SAMPLE CODE)
# ============================================
if [ -d "resources/java" ]; then
  echo "ðŸ“¥ Compiling archunit dependencies..."
  (cd resources/java && ./compile.sh 2>/dev/null)
  echo "âœ… Archunit dependencies installed"
fi

# ============================================
# 5. PATH SETUP
# ============================================
export PATH="$(pwd)/.venv/bin:${PATH}"

# ============================================
# 6. MCP SERVER SCRIPT PERMISSIONS
# ============================================
# Ensure MCP server scripts have correct permissions and no extended attributes
for script in scripts/start_mcp_server.sh scripts/start_mcp_server.ps1; do
  if [ -f "$script" ]; then
    # Clear macOS extended attributes (quarantine flags) if xattr is available
    if command -v xattr &> /dev/null; then
      xattr -c "$script" 2>/dev/null || true
    fi
  fi
done

# ============================================
# 7. OPTIONAL: LLM CONFIGURATION
# ============================================
# Uncomment and configure if using local LLM
# export LLM_MODEL="mistral"
# export LLM_API_ENDPOINT="http://localhost:11434"

# Uncomment if using GitHub Copilot for faster fixes
# export GITHUB_TOKEN="your_token_here"

# ============================================
# ENVIRONMENT READY
# ============================================
echo "âœ… Environment ready!"
echo "   Python: $(python --version 2>&1)"
echo "   PYTHONPATH: configured"
echo "   Virtual env: activated"
echo ""
